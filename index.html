<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Physics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- MathJax para renderizar ecuaciones LaTeX -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            background-color: #000; /* Fondo negro para evitar bordes blancos */
        }
        .font-game {
             font-family: 'Press Start 2P', cursive;
        }
        canvas {
            display: block;
            transition: background 0.5s ease;
        }
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        /* Estilo para los sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
            margin-top: -8px;
            border: 2px solid #DAA520;
            box-shadow: 0 0 5px #FFD700;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }
        .control-button, .planet-button, .graph-button, .menu-button {
            @apply bg-gray-700/50 text-white text-xs py-2 px-3 rounded-lg hover:bg-gray-600/70 transition-colors duration-200 flex items-center justify-center gap-2;
        }
        .planet-button.active, .graph-button.active {
            @apply bg-blue-500/80 ring-2 ring-blue-300;
        }
        .sim-panel {
            @apply bg-slate-900/70 backdrop-blur-sm p-4 rounded-lg border border-slate-700 shadow-lg;
        }
        /* Estilos para el Popup de la Guía */
        #guidePopup .sim-panel {
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        #guideContent {
            overflow-y: auto;
            padding-right: 15px; /* Espacio para el scrollbar */
        }
        #guideContent::-webkit-scrollbar { width: 8px; }
        #guideContent::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        #guideContent::-webkit-scrollbar-thumb { background: #FFD700; border-radius: 4px; }
        #guideContent::-webkit-scrollbar-thumb:hover { background: #f0c400; }
        #closeGuideBtn {
            font-size: 2rem; font-weight: bold; line-height: 1;
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.3);
            transition: background-color 0.2s;
        }
        #closeGuideBtn:hover {
            background-color: rgba(255,0,0,0.5);
        }
        #mobilePanel {
             background-color: rgba(15, 23, 42, 0.75); /* More translucent */
        }
        .share-button {
            @apply inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-bold text-white rounded-lg shadow-md transition-transform transform hover:scale-105 border-b-4 active:border-b-0 active:translate-y-1;
        }
        
    </style>
</head>
<body class="bg-black flex items-center justify-center h-screen m-0">

    <div id="gameContainer" class="relative w-full h-full shadow-2xl overflow-hidden">
        <canvas id="gameCanvas"></canvas>

        <!-- Pantalla de Inicio -->
        <div id="startScreen" class="absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center text-white text-center p-4 z-20">
            <h1 class="text-5xl md:text-7xl font-bold text-shadow mb-4 font-game">Flappy Physics</h1>
            <p class="text-lg md:text-xl mb-12 text-shadow font-game">Elige tu modo de experiencia</p>
            <div class="flex flex-col md:flex-row gap-6">
                <button id="simModeButton" class="menu-button font-game bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transform hover:scale-105 transition-transform duration-200 border-4 border-blue-600">
                    Simulación
                </button>
                <button id="gameModeButton" class="menu-button font-game bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-8 rounded-lg text-2xl shadow-lg transform hover:scale-105 transition-transform duration-200 border-4 border-green-600">
                    Juego
                </button>
            </div>
            <button id="closeTabButton" class="absolute bottom-4 left-4 text-xs font-game bg-gray-700/50 hover:bg-red-700/80 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-colors duration-200">
                Cerrar
            </button>
             <a id="creditLink" href="https://aulaquest.com" target="_blank" class="absolute bottom-4 right-4 text-white text-xs opacity-70 hover:opacity-100 transition-opacity z-30 font-game" style="text-shadow: 1px 1px 2px black;">creado por aulaquest</a>
        </div>
        
        <!-- HUD de Juego -->
        <div id="gameHud" class="absolute top-0 left-0 right-0 p-4 text-white text-shadow text-4xl font-game text-center hidden z-10">
            <span id="scoreDisplay">0</span>
            <button id="gameBackToMenuBtn" class="absolute top-4 right-4 text-sm font-bold bg-red-600/80 hover:bg-red-700 text-white py-2 px-3 rounded-lg transition-all">Menú</button>
        </div>

        <!-- Pantalla de Game Over -->
        <div id="gameOverScreen" class="absolute inset-0 bg-black bg-opacity-70 flex-col items-center justify-center text-white text-center p-4 z-20 hidden">
            <h2 class="text-4xl sm:text-6xl font-bold text-shadow mb-2 font-game text-red-500">Game Over</h2>
            <p class="text-2xl sm:text-3xl mb-1 font-game">Puntuación: <span id="finalScore">0</span></p>
            <p class="text-lg sm:text-xl mb-2 font-game">Monedas: <span id="finalCoins">0</span></p>
            <p class="text-lg sm:text-xl mb-6 font-game">Intentos: <span id="attemptCounter">0</span></p>
            
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-8">
                <div class="flex flex-col gap-4">
                    <button id="retryButton" class="menu-button font-game bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-bold py-3 px-6 sm:py-4 sm:px-8 rounded-lg text-xl sm:text-2xl shadow-lg transform hover:scale-105 transition-transform duration-200 border-4 border-yellow-600">
                        Reintentar
                    </button>
                    <button id="exitToMenuButton" class="menu-button font-game bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg text-base sm:text-lg shadow-lg transform hover:scale-105 transition-transform duration-200 border-4 border-red-700">
                        Salir al Menú
                    </button>
                </div>
                <div class="mt-6 sm:mt-0">
                    <p class="font-game text-sm mb-3">Compartir</p>
                    <div class="flex gap-4 justify-center">
                         <a id="shareWhatsapp" href="#" target="_blank" class="share-button" style="background-color: #25D366; border-color: #128C7E;">WhatsApp</a>
                         <a id="shareTelegram" href="#" target="_blank" class="share-button" style="background-color: #0088cc; border-color: #0077B5;">Telegram</a>
                    </div>
                </div>
            </div>
        </div>


        <!-- HUD de Simulación -->
        <div id="simulationHud" class="absolute inset-0 pointer-events-none text-white p-4 hidden z-10">
            
            <!-- ====== LAYOUT ESCRITORIO (>768px) ====== -->
            <div class="hidden md:flex absolute top-4 left-4 flex-col gap-4 max-w-[260px] w-full pointer-events-auto">
                <div class="sim-panel">
                    <h3 class="text-base mb-2 text-yellow-300 font-bold">Datos de Vuelo</h3>
                    <p class="text-sm">Tiempo: <span id="hudTime">0.00</span> s</p>
                    <p class="text-sm">Altura: <span id="hudHeight">0.00</span> m</p>
                    <p class="text-sm">Velocidad: <span id="hudVelocity">0.00</span> m/s</p>
                    
                    <h3 class="text-base mt-4 mb-2 text-yellow-300 font-bold">Gráficas de Movimiento</h3>
                    <div id="graphPanel" class="flex flex-col flex-grow min-h-0 gap-2">
                         <div class="bg-black/20 rounded-md p-1 relative h-24">
                             <canvas id="graphY"></canvas>
                         </div>
                         <div class="bg-black/20 rounded-md p-1 relative h-24">
                             <canvas id="graphV"></canvas>
                         </div>
                    </div>
                </div>
                 <div id="didacticTip" class="text-xs text-cyan-300 italic h-10 mt-2"></div>
            </div>

            <div id="desktopSimulationPanel" class="hidden md:flex absolute top-4 right-4 h-auto w-full max-w-[240px] pointer-events-auto">
                <div class="sim-panel flex flex-col gap-4">
                    <div class="flex flex-col gap-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="pausePlayBtn" class="text-base w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg transition-all">Pausa</button>
                            <button id="exitButton" class="text-base w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg transition-all">Salir</button>
                        </div>
                        <button id="guideButton" class="text-base w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg transition-all">Guía</button>
                    </div>

                    <div>
                         <h3 class="text-base mb-2 text-yellow-300 font-bold">Parámetros Físicos</h3>
                        <label class="block mb-1 text-sm">Impulso (Δv): <span id="liftValue">9.0</span> m/s</label>
                        <input type="range" id="liftSlider" min="1" max="15" step="0.1" value="9">
                         <label class="block mb-1 text-sm mt-2">Masa: <span id="massValue">1.0</span> kg</label>
                        <input type="range" id="massSlider" min="0.1" max="5" step="0.1" value="1.0">
                    </div>
                    
                    <div class="flex flex-col flex-grow min-h-0">
                         <h3 class="text-base mb-2 text-yellow-300 font-bold">Entorno Planetario</h3>
                        <div class="grid grid-cols-3 gap-2 mb-2 text-[10px]">
                            <button id="earthBtn" class="planet-button">Tierra</button>
                            <button id="moonBtn" class="planet-button">Luna</button>
                            <button id="marsBtn" class="planet-button">Marte</button>
                            <button id="jupiterBtn" class="planet-button">Júpiter</button>
                            <button id="saturnBtn" class="planet-button">Saturno</button>
                            <button id="sunBtn" class="planet-button">Sol</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== LAYOUT MÓVIL (<768px) ====== -->
            <div id="mobile-ui" class="md:hidden contents">
                <!-- Overlay for Mobile Panel -->
                <div id="mobilePanelOverlay" class="fixed inset-0 bg-black/50 z-30 opacity-0 hidden transition-opacity duration-300"></div>
                
                <!-- Top Bar (Mobile) -->
                <div class="absolute top-4 left-4 right-4 pointer-events-auto">
                    <div class="sim-panel p-2 flex justify-between items-center">
                        <button id="mobileMenuBtn" class="font-bold text-2xl px-3 py-1 text-yellow-300">☰</button>
                        <div class="flex gap-2">
                             <button id="mobilePausePlayBtn" class="text-sm font-bold w-20 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg transition-all">Pausa</button>
                             <button id="mobileExitBtn" class="text-sm font-bold w-20 bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg transition-all">Salir</button>
                        </div>
                    </div>
                </div>

                <!-- Sliding Panel (Mobile) -->
                <div id="mobilePanel" class="fixed top-0 left-0 h-full w-4/5 max-w-[300px] backdrop-blur-sm z-40 p-4 transform -translate-x-full transition-transform duration-300 ease-in-out pointer-events-auto overflow-y-auto">
                    <div class="flex flex-col gap-6 text-white pt-8">
                        <div>
                             <button id="mobilePanelCloseBtnText" class="text-base w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded-lg transition-all mb-4">Cerrar Menú</button>
                             <button id="mobileGuideBtn" class="text-base w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg transition-all">Ver Guía de Simulación</button>
                        </div>
                        <div>
                            <h3 class="text-base mb-2 text-yellow-300 font-bold">Datos de Vuelo</h3>
                            <p class="text-sm">Tiempo: <span id="mobileHudTime">0.00</span> s</p>
                            <p class="text-sm">Altura: <span id="mobileHudHeight">0.00</span> m</p>
                            <p class="text-sm">Velocidad: <span id="mobileHudVelocity">0.00</span> m/s</p>
                        </div>
                        
                        <div>
                            <h3 class="text-base mb-2 text-yellow-300 font-bold">Parámetros Físicos</h3>
                            <label class="block mb-1 text-sm">Impulso (Δv): <span id="mobileLiftValue">9.0</span> m/s</label>
                            <input type="range" id="mobileLiftSlider" min="1" max="15" step="0.1" value="9">
                             <label class="block mb-1 text-sm mt-2">Masa: <span id="mobileMassValue">1.0</span> kg</label>
                            <input type="range" id="mobileMassSlider" min="0.1" max="5" step="0.1" value="1.0">
                        </div>
                    
                        <div>
                             <h3 class="text-base mb-2 text-yellow-300 font-bold">Entorno Planetario</h3>
                            <div class="grid grid-cols-2 gap-2 mb-2 text-xs">
                                <button id="mobileEarthBtn" class="planet-button">Tierra</button>
                                <button id="mobileMoonBtn" class="planet-button">Luna</button>
                                <button id="mobileMarsBtn" class="planet-button">Marte</button>
                                <button id="mobileJupiterBtn" class="planet-button">Júpiter</button>
                                <button id="mobileSaturnBtn" class="planet-button">Saturno</button>
                                <button id="mobileSunBtn" class="planet-button">Sol</button>
                            </div>
                        </div>

                         <div>
                            <h3 class="text-base mb-2 text-yellow-300 font-bold">Gráficas</h3>
                            <div class="flex flex-col flex-grow min-h-0 gap-2">
                                 <div class="bg-black/20 rounded-md p-1 relative h-28"><canvas id="mobileGraphY"></canvas></div>
                                 <div class="bg-black/20 rounded-md p-1 relative h-28"><canvas id="mobileGraphV"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- POPUP GUÍA -->
            <div id="guidePopup" class="absolute inset-0 bg-black/80 flex items-center justify-center z-40 hidden pointer-events-auto p-4">
                <div class="sim-panel max-w-lg w-full text-left relative">
                    <button id="closeGuideBtn" class="absolute top-3 right-3 text-white">&times;</button>
                    <h2 class="text-2xl text-yellow-300 font-bold mb-4 font-game text-center">Guía de Simulación</h2>
                    <div id="guideContent" class="space-y-3 text-sm">
                        <p>¡Bienvenido a Flappy Physics! Esto es un simulador de **caída libre y tiro vertical**.</p>
                        <p><strong class="text-yellow-400">¿Qué puedes hacer?</strong> Manipula las condiciones de un vuelo para entender conceptos como la gravedad, el impulso y la masa.</p>
                        <ul class="list-disc list-inside space-y-2">
                            <li><strong>Parámetros Físicos:</strong> Usa los deslizadores para cambiar el <strong class="text-yellow-400">Impulso (Δv)</strong> y la <strong class="text-yellow-400">Masa</strong>.</li>
                            <li><strong>Entorno Planetario:</strong> Cambia la gravedad para ver cómo afecta al movimiento.</li>
                            <li><strong>Gráficas:</strong> Analiza las 2 gráficas para ver cómo la Altura (y) y la Velocidad (v) cambian en tiempo real.</li>
                        </ul>
                         <h3 class="text-lg text-yellow-300 font-bold pt-2 border-t border-slate-700/50">Ecuaciones Clave</h3>
                         <p>El movimiento del pájaro se rige por las ecuaciones del Movimiento Rectilíneo Uniformemente Acelerado (MRUA):</p>
                         <div class="text-center my-2 text-base">
                             <p>\( y(t) = y_0 + v_0 t + \frac{1}{2} g t^2 \)</p>
                             <p>\( F_{gravedad} = m \cdot g \)</p>
                         </div>
                         <p class="text-xs italic">Donde <strong>y(t)</strong> es la altura en el tiempo <strong>t</strong>, <strong>v₀</strong> es la velocidad inicial, <strong>y₀</strong> la altura inicial, y <strong>g</strong> es la aceleración de la gravedad.</p>
                        <p class="pt-2 border-t border-slate-700/50"><strong class="text-yellow-400">Concepto Clave:</strong> En ausencia de aire, todos los objetos caen con la misma aceleración. ¡Comprueba si cambiar la masa del pájaro afecta su movimiento!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Referencias a Elementos del DOM ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('gameContainer');
        const startScreen = document.getElementById('startScreen');
        const simulationHud = document.getElementById('simulationHud');
        const simModeButton = document.getElementById('simModeButton');
        const gameModeButton = document.getElementById('gameModeButton');
        const didacticTip = document.getElementById('didacticTip');
        const closeTabButton = document.getElementById('closeTabButton');

        // --- DOM Juego ---
        const gameHud = document.getElementById('gameHud');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScore = document.getElementById('finalScore');
        const finalCoins = document.getElementById('finalCoins');
        const retryButton = document.getElementById('retryButton');
        const exitToMenuButton = document.getElementById('exitToMenuButton');
        const gameBackToMenuBtn = document.getElementById('gameBackToMenuBtn');
        const attemptCounter = document.getElementById('attemptCounter');

        // --- DOM Escritorio ---
        const hudTime = document.getElementById('hudTime');
        const hudHeight = document.getElementById('hudHeight');
        const hudVelocity = document.getElementById('hudVelocity');
        const liftSlider = document.getElementById('liftSlider');
        const massSlider = document.getElementById('massSlider');
        const liftValue = document.getElementById('liftValue');
        const massValue = document.getElementById('massValue');
        const exitButton = document.getElementById('exitButton');
        const pausePlayBtn = document.getElementById('pausePlayBtn');
        const guideButton = document.getElementById('guideButton');
        const planetButtons = { 
            tierra: document.getElementById('earthBtn'), luna: document.getElementById('moonBtn'), marte: document.getElementById('marsBtn'), 
            jupiter: document.getElementById('jupiterBtn'), saturno: document.getElementById('saturnBtn'), sol: document.getElementById('sunBtn')
        };
        const graphCanvasY = document.getElementById('graphY');
        const graphCanvasV = document.getElementById('graphV');
        const graphCtxY = graphCanvasY.getContext('2d');
        const graphCtxV = graphCanvasV.getContext('2d');

        // --- DOM Móvil ---
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobilePanel = document.getElementById('mobilePanel');
        const mobilePanelCloseBtnText = document.getElementById('mobilePanelCloseBtnText');
        const mobilePanelOverlay = document.getElementById('mobilePanelOverlay');
        const mobilePausePlayBtn = document.getElementById('mobilePausePlayBtn');
        const mobileExitBtn = document.getElementById('mobileExitBtn');
        const mobileGuideBtn = document.getElementById('mobileGuideBtn');
        const mobileHudTime = document.getElementById('mobileHudTime');
        const mobileHudHeight = document.getElementById('mobileHudHeight');
        const mobileHudVelocity = document.getElementById('mobileHudVelocity');
        const mobileLiftSlider = document.getElementById('mobileLiftSlider');
        const mobileMassSlider = document.getElementById('mobileMassSlider');
        const mobileLiftValue = document.getElementById('mobileLiftValue');
        const mobileMassValue = document.getElementById('mobileMassValue');
        const mobilePlanetButtons = { 
            tierra: document.getElementById('mobileEarthBtn'), luna: document.getElementById('mobileMoonBtn'), marte: document.getElementById('mobileMarsBtn'),
            jupiter: document.getElementById('mobileJupiterBtn'), saturno: document.getElementById('mobileSaturnBtn'), sol: document.getElementById('mobileSunBtn')
        };
        const mobileGraphCanvasY = document.getElementById('mobileGraphY');
        const mobileGraphCanvasV = document.getElementById('mobileGraphV');
        const mobileGraphCtxY = mobileGraphCanvasY.getContext('2d');
        const mobileGraphCtxV = mobileGraphCanvasV.getContext('2d');

        // --- DOM Popups ---
        const guidePopup = document.getElementById('guidePopup');
        const closeGuideBtn = document.getElementById('closeGuideBtn');

        // --- Estado del Juego y Simulación ---
        let gameState = 'start', isPaused = false, currentPlanet = 'tierra';
        let bird, frameCount = 0, clouds, stars, impulseTimer = 0, simulationTime = 0;
        let history = { y: [], v: [] };
        let audioCtx;
        let lunaCraters = [];
        let pipes = [], coins = [], score = 0, coinCount = 0, gameFrame = 0, basePipeSpeed = 3, attemptCount = 0;
        let isMobile = false;
        let isBoosted = false, boostTimer = 0;
        let responsiveSettings = {};
        let waitingForFirstTap = false;
        
        // --- Constantes Físicas ---
        const PIXELS_PER_METER = 20, FPS = 60;
        const GRAVITY_PRESETS = {
            tierra: { g: 9.81, bg: 'linear-gradient(to top, #4A90E2 0%, #87CEEB 100%)', planetColor: '#4169E1' },
            luna: { g: 1.62, bg: 'linear-gradient(to top, #0c0e1a 0%, #2c3e50 100%)', planetColor: '#B0C4DE' },
            marte: { g: 3.71, bg: 'linear-gradient(to top, #e67e22 0%, #d35400 100%)', planetColor: '#BC5835' },
            jupiter: { g: 24.79, bg: 'linear-gradient(to top, #c9a888 0%, #8a6c4c 100%)', planetColor: '#DEB887' },
            saturno: { g: 10.44, bg: 'linear-gradient(to top, #2c3e50 0%, #1a222f 100%)', planetColor: '#E3D8B8' },
            sol: { g: 45.0, bg: 'linear-gradient(to top, #111 0%, #000 100%)', planetColor: '#FFD700' }
        };
        const BIRD_PROPS = { WIDTH: 50, HEIGHT: 40, LIFT: 9, VELOCITY: 0, MASS: 1.0, trail: [] };
        const GAME_BACKGROUNDS = {
            day: 'linear-gradient(to top, #87CEEB 0%, #4A90E2 100%)',
            night: 'linear-gradient(to top, #0c0e1a 0%, #2c3e50 100%)',
            sunrise: 'linear-gradient(to top, #f2994a, #f2c94c, #87CEEB)'
        };
        let currentGameBackground = '';

        // --- Funciones de Ayuda y Dibujo ---
        function initAudio() { if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("Web Audio API is not supported in this browser"); } } }
        function playJumpSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'square'; o.frequency.setValueAtTime(880, audioCtx.currentTime); g.gain.setValueAtTime(0.05, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.1); }
        function playPointSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'triangle'; o.frequency.setValueAtTime(1200, audioCtx.currentTime); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.1); }
        function playCoinSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'square'; o.frequency.setValueAtTime(1500, audioCtx.currentTime); g.gain.setValueAtTime(0.15, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.15); }
        function playGameOverSound() { if (!audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(440, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(220, audioCtx.currentTime + 0.5); g.gain.setValueAtTime(0.3, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.5); }
        function setupPlanetDetails() { lunaCraters = []; for (let i = 0; i < 80; i++) { lunaCraters.push({ x: Math.random() * 1600 - 800, y: Math.random() * 800 - 400, radius: Math.random() * 50 + 5 }); } }
        function setupStars() { stars = []; for (let i = 0; i < 150; i++) { stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, radius: Math.random() * 1.5, alpha: Math.random(), twinkleOffset: Math.random() * 2 * Math.PI, twinkleSpeed: Math.random() * 0.03 + 0.01 }); } }
        
        function manageEnvironment() {
            if (gameState === 'simulation') {
                if (currentPlanet === 'sol') {
                    drawSunRays();
                    drawStars();
                } else if (currentPlanet === 'tierra') {
                    drawClouds();
                } else {
                    drawDistantGalaxy();
                    drawStars();
                }
            } else if (gameState === 'game') {
                 if (currentGameBackground === GAME_BACKGROUNDS.night) {
                    drawStars();
                }
                drawClouds();
            }
        }
        function drawSunRays() { const sunCenterX = canvas.width / 2; const sunCenterY = canvas.height * 1.1; const numRays = 16; for (let i = 0; i < numRays; i++) { ctx.save(); ctx.translate(sunCenterX, sunCenterY); const angle = (i / numRays) * Math.PI * 2 + frameCount * 0.001; ctx.rotate(angle); const rayGrad = ctx.createLinearGradient(150, 0, canvas.width, 0); const alpha = 0.1 + Math.sin(frameCount * 0.05 + i * 5) * 0.05; rayGrad.addColorStop(0, `rgba(255, 220, 180, ${alpha})`); rayGrad.addColorStop(1, 'rgba(255, 220, 180, 0)'); ctx.fillStyle = rayGrad; ctx.beginPath(); ctx.moveTo(150, 0); ctx.lineTo(canvas.width, -50); ctx.lineTo(canvas.width, 50); ctx.closePath(); ctx.fill(); ctx.restore(); } }
        function drawDistantGalaxy() { ctx.save(); ctx.translate(canvas.width * 0.8, canvas.height * 0.25); ctx.rotate(-0.4 + frameCount * -0.0001); let galaxyGrad = ctx.createRadialGradient(0,0,10, 0,0,150); galaxyGrad.addColorStop(0, 'rgba(255, 255, 255, 0.2)'); galaxyGrad.addColorStop(0.3, 'rgba(200, 200, 255, 0.1)'); galaxyGrad.addColorStop(1, 'rgba(150, 150, 255, 0)'); ctx.fillStyle = galaxyGrad; for(let i = 0; i < 800; i++) { let angle = i * 0.15; let dist = Math.pow(i, 0.7); let x = Math.cos(angle) * dist; let y = Math.sin(angle) * dist; ctx.beginPath(); ctx.arc(x, y, Math.random() * 1.5, 0, Math.PI * 2); ctx.fill(); } ctx.restore(); }
        
        function drawClouds(){
            if(frameCount % 150 === 0){
                clouds.push({
                    x: canvas.width + 100,
                    y: Math.random() * canvas.height * 0.5,
                    parts: [],
                    speed: Math.random() * 0.5 + 0.5
                });
                const baseSize = Math.random() * 20 + 20;
                for(let i=0; i < (gameState === 'game' ? 5 : 1); i++) {
                    clouds[clouds.length-1].parts.push({
                        dx: (Math.random() - 0.5) * baseSize * 2,
                        dy: (Math.random() - 0.5) * baseSize * 0.5,
                        size: baseSize * (Math.random() * 0.5 + 0.5)
                    });
                }
            }
            
            clouds.forEach(cloud => {
                cloud.x -= cloud.speed;
                if(gameState === 'game') {
                    const grad = ctx.createLinearGradient(cloud.x, cloud.y - 30, cloud.x, cloud.y + 30);
                    grad.addColorStop(0, 'rgba(255, 255, 255, 0.95)');
                    grad.addColorStop(1, 'rgba(210, 220, 230, 0.8)');
                    ctx.fillStyle = grad;
                } else {
                    ctx.fillStyle='rgba(255, 255, 255, 0.9)';
                }

                ctx.beginPath();
                cloud.parts.forEach(part => {
                    ctx.moveTo(cloud.x + part.dx, cloud.y + part.dy);
                    ctx.arc(cloud.x + part.dx, cloud.y + part.dy, part.size, 0, Math.PI * 2);
                });
                ctx.fill();
            });

            clouds = clouds.filter(cloud => cloud.x + 100 > 0);
        }

        function drawStars() { stars.forEach(star => { star.alpha = 0.5 + 0.5 * Math.sin(star.twinkleOffset + frameCount * star.twinkleSpeed); ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`; ctx.beginPath(); ctx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI); ctx.fill(); }); }
        
        function drawBird() {
            // Draw Trail if boosted
            if(isBoosted && bird.trail.length > 0) {
                ctx.save();
                bird.trail.forEach((p, i) => {
                    const alpha = (i / bird.trail.length) * 0.5;
                    ctx.fillStyle = `rgba(255, 99, 71, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, (i / bird.trail.length) * (bird.WIDTH/3), 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.restore();
            }

            ctx.save();
            const angle = Math.max(-Math.PI / 4, Math.min(Math.PI / 6, bird.VELOCITY / 15));
            ctx.translate(bird.x, bird.y);
            ctx.rotate(angle);
            
            // Cuerpo
            const bodyGrad = ctx.createRadialGradient(0, 0, 5, 0, 0, bird.WIDTH / 2);
            bodyGrad.addColorStop(0, '#FFEB3B');
            bodyGrad.addColorStop(1, '#FBC02D');
            ctx.fillStyle = bodyGrad;
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(0, 0, bird.WIDTH / 2, bird.HEIGHT / 2, 0, 0, 2 * Math.PI);
            ctx.fill();

            if (gameState === 'game') {
                const innerShadow = ctx.createRadialGradient(0, 5, bird.WIDTH/4, 0, 0, bird.WIDTH/2);
                innerShadow.addColorStop(0, 'rgba(0,0,0,0)');
                innerShadow.addColorStop(1, 'rgba(0,0,0,0.25)');
                ctx.fillStyle = innerShadow;
                ctx.fill();
            }
             ctx.stroke();

            // Ala
            const wingFlap = Math.sin(frameCount * 0.4) * 5;
            ctx.fillStyle = '#FFF9C4';
            ctx.beginPath();
            ctx.moveTo(-bird.WIDTH / 5, -wingFlap);
            ctx.quadraticCurveTo(0, -bird.HEIGHT / 2.5 - wingFlap, bird.WIDTH / 4, -wingFlap);
            ctx.quadraticCurveTo(0, bird.HEIGHT / 3 - wingFlap, -bird.WIDTH / 5, -wingFlap);
            ctx.fill();
            ctx.stroke();
            
            // Ojo
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(bird.WIDTH / 4, -bird.HEIGHT / 6, 5, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(bird.WIDTH / 4 + 1, -bird.HEIGHT / 6, 2, 0, 2 * Math.PI);
            ctx.fill();
            
            // Pico
            ctx.fillStyle = '#F57C00';
            ctx.beginPath();
            ctx.moveTo(bird.WIDTH / 2 - 5, -3);
            ctx.lineTo(bird.WIDTH / 2 + 8, 0);
            ctx.lineTo(bird.WIDTH / 2 - 5, 3);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            ctx.restore();
        }
        function drawVectors(){const birdCenterX=bird.x;const birdCenterY=bird.y;ctx.save();ctx.strokeStyle='red';ctx.lineWidth=3;ctx.fillStyle='red';ctx.beginPath();ctx.moveTo(birdCenterX,birdCenterY);ctx.lineTo(birdCenterX,birdCenterY+50);ctx.lineTo(birdCenterX-5,birdCenterY+40);ctx.moveTo(birdCenterX,birdCenterY+50);ctx.lineTo(birdCenterX+5,birdCenterY+40);ctx.stroke();ctx.font="16px 'Press Start 2P'";ctx.fillText("g",birdCenterX+10,birdCenterY+45);ctx.restore();if(impulseTimer>0){ctx.save();ctx.strokeStyle='#00FF00';ctx.lineWidth=3;ctx.fillStyle='#00FF00';ctx.beginPath();ctx.moveTo(birdCenterX,birdCenterY);ctx.lineTo(birdCenterX,birdCenterY-50);ctx.lineTo(birdCenterX-5,birdCenterY-40);ctx.moveTo(birdCenterX,birdCenterY-50);ctx.lineTo(birdCenterX+5,birdCenterY-40);ctx.stroke();ctx.font="12px 'Press Start 2P'";ctx.fillText("Impulso",birdCenterX-30,birdCenterY-55);ctx.restore();impulseTimer--}}

        function updateResponsiveSettings() {
            isMobile = window.matchMedia("(max-width: 1024px)").matches || /Mobi|Android/i.test(navigator.userAgent);
            
            const isLandscape = canvas.width > canvas.height;

            let birdScale;
            if (isMobile && isLandscape) {
                birdScale = canvas.height / 300; // Aumentado para pájaro más grande en apaisado
            } else {
                birdScale = canvas.height / 800;
            }
            birdScale = Math.max(0.5, birdScale);

            responsiveSettings.birdWidth = (isMobile ? 52 : 50) * birdScale;
            responsiveSettings.birdHeight = (isMobile ? 42 : 40) * birdScale;

            responsiveSettings.pipeWidth = Math.max(50, canvas.width * 0.1);
            
            const baseGapPercentage = (isMobile && !isLandscape) ? 0.35 : (isMobile ? 0.45 : 0.28);
            responsiveSettings.pipeGap = Math.max(160, canvas.height * baseGapPercentage);

            responsiveSettings.pipeSpawnInterval = isMobile ? Math.floor(65 * (canvas.width / 400)) : Math.max(120, canvas.width / 7);

            responsiveSettings.pipeGapMargin = canvas.height * 0.15;
            responsiveSettings.pipeGapRange = canvas.height - responsiveSettings.pipeGap - (responsiveSettings.pipeGapMargin * 2);
        }

        function resizeCanvas() {
            const container = document.body;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            [graphCanvasY, graphCanvasV, mobileGraphCanvasY, mobileGraphCanvasV].forEach(graphCanvas => {
                if (graphCanvas && graphCanvas.parentElement) {
                    graphCanvas.width = graphCanvas.parentElement.clientWidth;
                    graphCanvas.height = graphCanvas.parentElement.clientHeight;
                }
            });

            updateResponsiveSettings();
            
            if (bird) {
                bird.WIDTH = responsiveSettings.birdWidth;
                bird.HEIGHT = responsiveSettings.birdHeight;
            }
        }

        function setup(mode) {
            updateResponsiveSettings();
            bird = { ...BIRD_PROPS, x: canvas.width / 2, y: canvas.height / 2, trail: [] };
            clouds = [];
            setupStars();
            frameCount = 0; gameFrame = 0;
            history = { y: [], v: [] };
            pipes = []; coins = []; score = 0; coinCount = 0; 
            basePipeSpeed = isMobile ? 2.5 : 3;
            isBoosted = false; boostTimer = 0;
            
            if (mode === 'simulation') {
                bird.x = canvas.width / 2.5;
                setupPlanetDetails(); setGravity('tierra');
                liftSlider.value = 9; mobileLiftSlider.value = 9;
                massSlider.value = 1.0; mobileMassSlider.value = 1.0;
                bird.LIFT = (parseFloat(liftSlider.value) * PIXELS_PER_METER) / FPS;
                bird.MASS = 1.0;
                pausePlayBtn.textContent = 'Pausa'; mobilePausePlayBtn.textContent = 'Pausa';
                updateSliderLabels();
            } else if (mode === 'game') {
                bird.WIDTH = responsiveSettings.birdWidth;
                bird.HEIGHT = responsiveSettings.birdHeight;
                bird.GRAVITY = (22 * PIXELS_PER_METER) / (FPS * FPS); 
                bird.LIFT = (8.5 * PIXELS_PER_METER) / FPS; 
                canvas.style.background = GAME_BACKGROUNDS.day;
                 currentGameBackground = GAME_BACKGROUNDS.day;
                 if (isMobile) {
                    waitingForFirstTap = true;
                 }
            }
        }

        function gameLoop() {
            if (gameState === 'start' || gameState === 'gameOver') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (gameState === 'simulation') {
                manageEnvironment();
                drawPlanet();
                if (!isPaused) updateSimulation();
                drawSimulation();
            } else if (gameState === 'game') {
                updateGameBackground();
                manageEnvironment();
                if (!isPaused && !waitingForFirstTap) updateGame();
                drawGame();
                if(waitingForFirstTap) {
                     ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                     ctx.fillRect(0, canvas.height / 2 - 40, canvas.width, 80);
                     ctx.fillStyle = 'white';
                     ctx.font = `bold ${isMobile ? '20px' : '30px'} 'Press Start 2P'`;
                     ctx.textAlign = 'center';
                     ctx.fillText('Toca para empezar', canvas.width / 2, canvas.height / 2 + 10);
                }
            }
            
            frameCount++; 
            requestAnimationFrame(gameLoop);
        }
        
        function updateGameBackground() {
            const stage = Math.floor(score / 100) % 3;
            let newBg;
            switch(stage) {
                case 0: newBg = GAME_BACKGROUNDS.day; break;
                case 1: newBg = GAME_BACKGROUNDS.night; break;
                case 2: newBg = GAME_BACKGROUNDS.sunrise; break;
                default: newBg = GAME_BACKGROUNDS.day;
            }
            if (newBg !== currentGameBackground) {
                currentGameBackground = newBg;
                canvas.style.background = newBg;
            }
        }


        // --- SIMULATION LOGIC ---
        function updateSimulation() {
             updateBirdPhysics();
             if (bird.y - bird.HEIGHT / 2 < 0) bird.y = bird.HEIGHT/2;
             if (bird.y + bird.HEIGHT / 2 > canvas.height) bird.y = canvas.height - bird.HEIGHT / 2;
             if (bird.y === bird.HEIGHT / 2 || bird.y === canvas.height - bird.HEIGHT / 2) bird.VELOCITY = 0;
             updateHud(); simulationTime += 1/FPS;
        }
        function drawSimulation() { drawTrajectory(); drawBird(); drawVectors(); drawAllGraphs(); }
        function updateBirdPhysics() { bird.VELOCITY += bird.GRAVITY; bird.y += bird.VELOCITY; }

        // --- GAME LOGIC ---
        function updateGame() {
            updateBirdPhysics();
            if (bird.y + bird.HEIGHT / 2 > canvas.height || bird.y - bird.HEIGHT / 2 < 0) {
                endGame();
            }

            // --- Boost Timer ---
            if (isBoosted) {
                boostTimer--;
                bird.trail.push({x: bird.x, y: bird.y});
                if(bird.trail.length > 10) bird.trail.shift();
                if (boostTimer <= 0) {
                    isBoosted = false;
                    bird.trail = [];
                }
            }


            // --- Velocidad de tuberías ---
            let currentPipeSpeed = basePipeSpeed;
            if (score > 300) {
                 const pointsOver300 = score - 300;
                 const increments = Math.floor(pointsOver300 / 50);
                 const percentageIncrease = Math.min(20, increments); // Máximo 20%
                 currentPipeSpeed *= (1 + percentageIncrease / 100);
            }
            if (isBoosted) {
                currentPipeSpeed *= 1.20;
            }

            // --- Generación y actualización de tuberías ---
            if (gameFrame % responsiveSettings.pipeSpawnInterval === 0) {
                const gapY = Math.random() * responsiveSettings.pipeGapRange + responsiveSettings.pipeGapMargin + (responsiveSettings.pipeGap / 2);

                const newPipe = { 
                    x: canvas.width, 
                    y: gapY, 
                    width: responsiveSettings.pipeWidth, 
                    gap: responsiveSettings.pipeGap, 
                    scored: false,
                    baseY: gapY,
                    baseGap: responsiveSettings.pipeGap
                };

                if (score >= 200 && Math.random() < 0.5) {
                    const moveType = Math.random();
                    if (moveType < 0.5) { 
                        newPipe.pulsating = true;
                        newPipe.pulseSpeed = (Math.random() * 0.02) + 0.03;
                        newPipe.pulseOffset = Math.random() * Math.PI * 2;
                    } else { 
                        newPipe.shifting = true;
                        newPipe.shiftSpeed = (Math.random() * 0.015) + 0.02;
                        newPipe.shiftOffset = Math.random() * Math.PI * 2;
                    }
                }
                pipes.push(newPipe);
                 if (score >= 50 && Math.random() < 0.1) {
                    coins.push({ x: canvas.width + newPipe.width / 2, y: gapY, radius: 15, collected: false, type: 'powerup' });
                } else if (Math.random() > 0.4) {
                    coins.push({ x: canvas.width + newPipe.width / 2, y: gapY, radius: 15, collected: false, type: 'normal' });
                }
            }
            
            pipes.forEach(pipe => {
                pipe.x -= currentPipeSpeed;

                if (pipe.pulsating) {
                    pipe.gap = pipe.baseGap - Math.sin(gameFrame * pipe.pulseSpeed + pipe.pulseOffset) * 35;
                }
                if (pipe.shifting) {
                    pipe.y = pipe.baseY + Math.sin(gameFrame * pipe.shiftSpeed + pipe.shiftOffset) * 40;
                }


                if (pipe.x + pipe.width < 0) pipes.shift();
                
                if (bird.x + bird.WIDTH / 2 > pipe.x && bird.x - bird.WIDTH / 2 < pipe.x + pipe.width) {
                    if (bird.y - bird.HEIGHT / 2 < pipe.y - pipe.gap / 2 || bird.y + bird.HEIGHT / 2 > pipe.y + pipe.gap / 2) {
                        endGame();
                    }
                }

                if (!pipe.scored && pipe.x + pipe.width < bird.x) {
                    score++;
                    pipe.scored = true;
                }
            });

            // Coins
            coins.forEach((coin, index) => {
                coin.x -= currentPipeSpeed;
                if (coin.x + coin.radius < 0) coins.splice(index, 1);
                
                const dist = Math.hypot(bird.x - coin.x, bird.y - coin.y);
                if (dist < bird.WIDTH/2 + coin.radius) {
                    if (coin.type === 'powerup') {
                        isBoosted = true;
                        boostTimer = 5 * FPS; // 5 segundos
                    } else {
                        coinCount++;
                        score += 5;
                    }
                    playCoinSound();
                    coins.splice(index, 1);
                }
            });

            scoreDisplay.textContent = score;
            gameFrame++;
        }
        function drawGame() {
            drawPipes();
            drawCoins();
            drawBird();
        }
        function drawPipes() {
            pipes.forEach(pipe => {
                const pipeGrad = ctx.createLinearGradient(pipe.x, 0, pipe.x + pipe.width, 0);
                pipeGrad.addColorStop(0, '#65a30d');
                pipeGrad.addColorStop(0.3, '#a3e635');
                pipeGrad.addColorStop(1, '#65a30d');
                ctx.fillStyle = pipeGrad;

                const pipeBorder = '#4d7c0f';
                const capHeight = pipe.width * 0.4;

                // Top Pipe
                ctx.fillRect(pipe.x, 0, pipe.width, pipe.y - pipe.gap / 2);
                ctx.fillStyle = pipeBorder;
                ctx.fillRect(pipe.x - 5, pipe.y - pipe.gap / 2 - capHeight, pipe.width + 10, capHeight);
                
                // Bottom Pipe
                ctx.fillStyle = pipeGrad;
                ctx.fillRect(pipe.x, pipe.y + pipe.gap / 2, pipe.width, canvas.height);
                ctx.fillStyle = pipeBorder;
                ctx.fillRect(pipe.x - 5, pipe.y + pipe.gap / 2, pipe.width + 10, capHeight);

                // Highlight & Texture
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.fillRect(pipe.x, pipe.y - pipe.gap / 2 - capHeight, 5, capHeight);
                ctx.fillRect(pipe.x, pipe.y + pipe.gap / 2, 5, capHeight);
            });
        }
        function drawCoins() {
            coins.forEach(coin => {
                ctx.save();
                ctx.translate(coin.x, coin.y);
                ctx.scale(1, Math.sin(frameCount * 0.1) * 0.1 + 0.9); // Bobbing effect
                
                let coinGrad;
                if (coin.type === 'powerup') {
                    coinGrad = ctx.createRadialGradient(-5, -5, 2, 0, 0, coin.radius);
                    coinGrad.addColorStop(0, '#FFB6C1');
                    coinGrad.addColorStop(0.5, '#DC143C');
                    coinGrad.addColorStop(1, '#8B0000');
                    ctx.strokeStyle = '#8B0000';
                } else {
                    coinGrad = ctx.createRadialGradient(-5, -5, 2, 0, 0, coin.radius);
                    coinGrad.addColorStop(0, '#FFF');
                    coinGrad.addColorStop(0.5, '#FFD700');
                    coinGrad.addColorStop(1, '#DAA520');
                    ctx.strokeStyle = '#A07818';
                }
                
                ctx.fillStyle = coinGrad;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, coin.radius, 0, 2*Math.PI);
                ctx.fill();
                ctx.stroke();
                ctx.restore();
            });
        }

        function endGame() {
            playGameOverSound();
            gameState = 'gameOver';
            
            const shareText = encodeURIComponent(`¡He conseguido ${score} puntos en Flappy Physics! ¿Puedes superarme?`);
            const shareUrl = encodeURIComponent(window.location.href);

            document.getElementById('shareWhatsapp').href = `https://wa.me/?text=${shareText} ${shareUrl}`;
            document.getElementById('shareTelegram').href = `https://t.me/share/url?url=${shareUrl}&text=${shareText}`;

            gameOverScreen.classList.remove('hidden');
            gameOverScreen.classList.add('flex');
            finalScore.textContent = score;
            finalCoins.textContent = coinCount;
            attemptCounter.textContent = attemptCount;
        }

        // --- Shared Functions ---
        function updateHud() {
            const heightMeters = (canvas.height - bird.y) / PIXELS_PER_METER;
            const velocityMs = (-bird.VELOCITY * FPS) / PIXELS_PER_METER;
            
            hudTime.textContent = simulationTime.toFixed(2);
            mobileHudTime.textContent = simulationTime.toFixed(2);
            hudHeight.textContent = heightMeters.toFixed(2);
            mobileHudHeight.textContent = heightMeters.toFixed(2);
            hudVelocity.textContent = velocityMs.toFixed(2);
            mobileHudVelocity.textContent = velocityMs.toFixed(2);

            history.y.push(Math.max(0, heightMeters)); history.v.push(velocityMs);
            if(history.y.length > 300) { history.y.shift(); history.v.shift(); }
        }
        
        function drawPlanet() {
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height * 1.5);
            const rotation = frameCount * 0.0005;
            ctx.rotate(rotation);
            
            const planetRadius = canvas.height;
            
            ctx.beginPath();
            ctx.arc(0, 0, planetRadius, 0, 2 * Math.PI);
            ctx.fillStyle = GRAVITY_PRESETS[currentPlanet].planetColor;
            ctx.fill();
            ctx.clip(); 
            switch(currentPlanet) {
                case 'tierra':
                    // Continentes mejorados
                    ctx.fillStyle = '#228B22'; 
                    ctx.beginPath();
                    ctx.moveTo(50, -200); ctx.bezierCurveTo(200, -150, 250, 0, 150, 100); ctx.bezierCurveTo(80, 180, -50, 200, -150, 150); ctx.bezierCurveTo(-250, 50, -200, -100, 50, -200);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(-250, -50); ctx.bezierCurveTo(-350, 50, -300, 200, -200, 180); ctx.bezierCurveTo(-150, 150, -200, 0, -250, -50);
                    ctx.fill();

                    // Nubes de la atmósfera
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.25)';
                    ctx.beginPath();
                    ctx.ellipse(-100, -150, 150, 60, Math.PI / -6, 0, 2 * Math.PI); ctx.ellipse(150, 100, 200, 80, Math.PI / 4, 0, 2 * Math.PI); ctx.ellipse(0, 250, 180, 70, Math.PI / 3, 0, 2 * Math.PI);
                    ctx.fill();

                    // Casquetes polares
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.beginPath(); ctx.arc(0, -planetRadius + 15, 120, 0, Math.PI * 2); ctx.fill();
                    ctx.beginPath(); ctx.arc(0, planetRadius - 15, 90, 0, Math.PI * 2); ctx.fill();

                    // Sombra interna para dar esfericidad
                    const atmosphereGrad = ctx.createRadialGradient(0, 0, planetRadius * 0.8, 0, 0, planetRadius);
                    atmosphereGrad.addColorStop(0, 'transparent');
                    atmosphereGrad.addColorStop(1, 'rgba(0, 0, 0, 0.4)');
                    ctx.fillStyle = atmosphereGrad;
                    ctx.fillRect(-planetRadius, -planetRadius, planetRadius * 2, planetRadius * 2);
                    break;
                case 'marte':
                     // Casquete polar
                     ctx.fillStyle = 'rgba(255, 250, 240, 0.9)';
                     ctx.beginPath();
                     ctx.arc(0, -planetRadius + 10, 150, 0, 2 * Math.PI);
                     ctx.fill();
                    
                     // Manchas oscuras
                     ctx.fillStyle = 'rgba(100, 40, 20, 0.4)';
                     ctx.beginPath();
                     ctx.ellipse(-50, 100, 220, 120, Math.PI / 3, 0, 2*Math.PI);
                     ctx.ellipse(200, -150, 180, 100, -Math.PI / 4, 0, 2*Math.PI);
                     ctx.fill();

                     // Cráteres mejorados
                     lunaCraters.forEach(crater => {
                        // Sombra
                        ctx.fillStyle = 'rgba(0,0,0,0.15)';
                        ctx.beginPath();
                        ctx.arc(crater.x + crater.radius * 0.2, crater.y + crater.radius * 0.2, crater.radius, 0, 2 * Math.PI);
                        ctx.fill();
                        // Luz
                        ctx.fillStyle = 'rgba(255,255,255,0.05)';
                        ctx.beginPath();
                        ctx.arc(crater.x - crater.radius * 0.2, crater.y - crater.radius * 0.2, crater.radius, 0, 2 * Math.PI);
                        ctx.fill();
                     });
                    break;
                case 'jupiter':
                    const greatRedSpot = { x: 150, y: -100, w: 120, h: 70 };
                    const jupiterColors = ['#c9a888', '#8a6c4c', '#e0d1b3', '#a38c6d'];
                    for(let i=-6; i<7; i++) {
                        ctx.fillStyle = jupiterColors[Math.abs(i) % jupiterColors.length] + '80'; // Add alpha
                        ctx.beginPath(); 
                        let y_base = i * (planetRadius / 8);
                        let bandHeight = planetRadius / 8 + (Math.sin(i*0.5) * 10);
                        ctx.moveTo(-planetRadius * 1.5, y_base);
                        for (let x = -planetRadius * 1.5; x < planetRadius * 1.5; x += 50) {
                            ctx.lineTo(x, y_base + Math.sin(x / 300 + i + frameCount * 0.005) * 15);
                        }
                        ctx.lineTo(planetRadius * 1.5, y_base + bandHeight); 
                        ctx.lineTo(-planetRadius * 1.5, y_base + bandHeight);
                        ctx.closePath(); 
                        ctx.fill();
                    }
                    // Gran Mancha Roja
                    ctx.save();
                    ctx.translate(greatRedSpot.x, greatRedSpot.y);
                    ctx.rotate(-0.1 + frameCount * 0.002);
                    let spotGrad = ctx.createRadialGradient(0, 0, greatRedSpot.w * 0.2, 0, 0, greatRedSpot.w);
                    spotGrad.addColorStop(0, '#d89c7c');
                    spotGrad.addColorStop(1, '#a05c3c');
                    ctx.fillStyle = spotGrad; 
                    ctx.beginPath();
                    ctx.ellipse(0, 0, greatRedSpot.w, greatRedSpot.h, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.restore();
                    break;
                case 'saturno':
                    const saturnRadius = planetRadius * 0.55;
                    const tilt = -0.3;
                    ctx.save();
                    ctx.rotate(tilt);

                    // Sombra del planeta sobre los anillos
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    ctx.beginPath();
                    ctx.ellipse(0, 0, saturnRadius, saturnRadius * 0.4, 0, Math.PI, Math.PI*2);
                    ctx.fill();

                    // Anillos traseros (más oscuros)
                    drawRingPart(saturnRadius * 2.1, saturnRadius * 0.7, saturnRadius * 0.1, 'rgba(180, 170, 160, 0.6)', true); // Anillo A
                    drawRingPart(saturnRadius * 1.7, saturnRadius * 0.55, saturnRadius * 0.2, 'rgba(210, 200, 180, 0.7)', true); // Anillo B
                    ctx.restore(); 

                    // Planeta
                    let saturnGrad = ctx.createRadialGradient(-30, -30, 10, 0, 0, saturnRadius);
                    saturnGrad.addColorStop(0, '#F5EAC7'); saturnGrad.addColorStop(1, '#D2B48C');
                    ctx.fillStyle = saturnGrad;
                    ctx.beginPath();
                    ctx.arc(0, 0, saturnRadius, 0, 2 * Math.PI);
                    ctx.fill();

                    ctx.save();
                    ctx.rotate(tilt);
                    // Anillos delanteros (más brillantes)
                    drawRingPart(saturnRadius * 2.1, saturnRadius * 0.7, saturnRadius * 0.1, 'rgba(180, 170, 160, 1)', false); // Anillo A
                    drawRingPart(saturnRadius * 1.7, saturnRadius * 0.55, saturnRadius * 0.2, 'rgba(210, 200, 180, 1)', false); // Anillo B
                    ctx.restore();
                    break;
                 case 'sol':
                    ctx.rotate(-rotation); // Cancel planet rotation
                    ctx.translate(0, -planetRadius * 0.4); // Move sun up
                    const sunRadius = planetRadius * 0.8;
                    
                    let sunGrad = ctx.createRadialGradient(-50, -50, 20, 0, 0, sunRadius);
                    sunGrad.addColorStop(0, 'white');
                    sunGrad.addColorStop(0.5, '#FFD700');
                    sunGrad.addColorStop(1, '#FF8C00');
                    ctx.fillStyle = sunGrad;
                    ctx.beginPath();
                    ctx.arc(0, 0, sunRadius, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Turbulent surface effect
                    ctx.globalCompositeOperation = 'overlay';
                    ctx.globalAlpha = 0.2;
                    for (let i = 0; i < 20; i++) {
                        ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5})`;
                        ctx.beginPath();
                        const angle = Math.random() * Math.PI * 2;
                        const dist = Math.random() * sunRadius;
                        const size = Math.random() * 80 + 20;
                        ctx.ellipse(
                            Math.cos(angle) * dist, 
                            Math.sin(angle) * dist, 
                            size + Math.sin(frameCount * 0.02 + i) * 10, 
                            size/2 + Math.cos(frameCount * 0.03 + i) * 5, 
                            Math.random() * Math.PI * 2, 0, Math.PI * 2
                        );
                        ctx.fill();
                    }
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 1;
                    
                    // Flares
                    ctx.strokeStyle = `rgba(255, 200, 100, ${0.5 + Math.sin(frameCount * 0.1) * 0.2})`;
                    ctx.lineWidth = 3;
                    for (let i = 0; i < 7; i++) {
                        const angle = (i * Math.PI * 2 / 7) + frameCount * 0.002;
                        const length = sunRadius + 20 + Math.sin(frameCount * 0.05 + i * 2) * 20;
                        ctx.beginPath();
                        ctx.moveTo(Math.cos(angle) * sunRadius, Math.sin(angle) * sunRadius);
                        ctx.quadraticCurveTo(
                            Math.cos(angle + 0.1) * (sunRadius + length) / 2, Math.sin(angle + 0.1) * (sunRadius + length) / 2,
                            Math.cos(angle) * length, Math.sin(angle) * length
                        );
                        ctx.stroke();
                    }
                    break;
                case 'luna': 
                default:
                    ctx.beginPath();
                    ctx.arc(0, 0, planetRadius, 0, 2 * Math.PI);
                    ctx.fillStyle = GRAVITY_PRESETS[currentPlanet].planetColor;
                    ctx.fill();
            }
            ctx.restore();
        }
        function drawRingPart(radiusX, radiusY, lineWidth, color, isBack) {
             ctx.strokeStyle = color;
             ctx.lineWidth = lineWidth;
             ctx.beginPath();
             ctx.ellipse(0, 0, radiusX, radiusY, 0, isBack ? Math.PI : 0, isBack ? 2 * Math.PI : Math.PI);
             ctx.stroke();
        }
        function drawTrajectory() { /* ... */ }
        function drawAllGraphs() {
            drawGraph(graphCtxY, history.y, 'Altura (y)'); 
            drawGraph(graphCtxV, history.v, 'Velocidad (v)');
            drawGraph(mobileGraphCtxY, history.y, 'Altura (y)'); 
            drawGraph(mobileGraphCtxV, history.v, 'Velocidad (v)');
        }
        function drawGraph(graphCtx, data, label) {
            if (!graphCtx || !graphCtx.canvas.clientWidth) return;
            const w = graphCtx.canvas.width; const h = graphCtx.canvas.height; graphCtx.clearRect(0, 0, w, h);
            graphCtx.fillStyle = "white"; graphCtx.font = "10px 'Press Start 2P'"; graphCtx.textAlign = 'left'; graphCtx.fillText(label, 10, 15); 
            if (!data || data.length < 2) return;
            const maxAbs = Math.max(...data.map(val => Math.abs(val)), 1);
            const minVal = label === 'Altura (y)' ? 0 : -maxAbs;
            const maxVal = label === 'Altura (y)' ? Math.max(...data, 1) : maxAbs;
            graphCtx.strokeStyle = '#FFD700'; graphCtx.lineWidth = 2; graphCtx.beginPath();
            data.forEach((val, i) => { 
                if (isNaN(val)) return;
                const x = (i / (data.length - 1)) * w; const y = h - ((val - minVal) / (maxVal - minVal || 1)) * h;
                if (i === 0) graphCtx.moveTo(x, y); else graphCtx.lineTo(x, y); 
            });
            graphCtx.stroke();
            const lastVal = data[data.length - 1];
            if (lastVal !== undefined) {
                graphCtx.fillStyle = '#FFD700'; graphCtx.font = "11px 'Roboto Mono'"; graphCtx.textAlign = 'right';
                graphCtx.fillText(lastVal.toFixed(1), w - 5, 15);
            }
        }
        function setGravity(planetName) {
            currentPlanet = planetName;
            const preset = GRAVITY_PRESETS[planetName];
            bird.GRAVITY = (preset.g * PIXELS_PER_METER) / (FPS * FPS); 
            canvas.style.background = preset.bg;
            Object.values(planetButtons).forEach(btn => btn.classList.remove('active'));
            Object.values(mobilePlanetButtons).forEach(btn => btn.classList.remove('active'));
            if(planetButtons[planetName]) planetButtons[planetName].classList.add('active');
            if(mobilePlanetButtons[planetName]) mobilePlanetButtons[planetName].classList.add('active');
        }

        async function enterMobileExperience() {
            try {
                if(document.fullscreenElement) return; // Ya está en pantalla completa
                if (document.documentElement.requestFullscreen) {
                    await document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
                    await document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) { /* IE11 */
                    await document.documentElement.msRequestFullscreen();
                }
            } catch (err) {
                console.log(`Error al intentar activar el modo de pantalla completa: ${err.message}`);
            }

            try {
                if (screen.orientation && screen.orientation.lock) {
                   await screen.orientation.lock('landscape');
                }
            } catch (error) {
                console.log("No se pudo bloquear la orientación de la pantalla:", error);
            }
        }

        function startSimulation() { 
            setup('simulation'); gameState = 'simulation'; isPaused = false; 
            startScreen.classList.add('hidden'); 
            simulationHud.classList.remove('hidden'); 
            resizeCanvas(); gameLoop(); 
        }
        
        function startGame() {
            initAudio();
            if(isMobile) {
                enterMobileExperience();
            }
            attemptCount++;
            setup('game'); gameState = 'game'; isPaused = false;
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameOverScreen.classList.remove('flex');
            gameHud.classList.remove('hidden');
            resizeCanvas();
            gameLoop();
        }
        function goToMenu() { 
            gameState = 'start'; 
            simulationHud.classList.add('hidden'); 
            gameHud.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameOverScreen.classList.remove('flex');
            startScreen.classList.remove('hidden');
            setup('simulation'); // Setup for start screen animation
        }
        function togglePause() { isPaused = !isPaused; pausePlayBtn.textContent = isPaused ? 'Play' : 'Pausa'; mobilePausePlayBtn.textContent = isPaused ? 'Play' : 'Pausa'; }
        function openGuide() { guidePopup.classList.remove('hidden'); setTimeout(() => MathJax.typesetPromise(), 10); }
        function handleLiftChange(e) {
            const liftInMs = parseFloat(e.target.value);
            bird.LIFT = (liftInMs * PIXELS_PER_METER) / FPS;
            liftSlider.value = liftInMs; mobileLiftSlider.value = liftInMs;
            updateSliderLabels(); 
        }
        function handleMassChange(e) {
            bird.MASS = parseFloat(e.target.value);
            massSlider.value = bird.MASS; mobileMassSlider.value = bird.MASS;
            updateSliderLabels(); showTip("Nota: La masa no afecta la caída libre. ¡'g' es la misma para todos!");
        }
        function handleInput(e) {
            if (e.code === 'Space' || e.type === 'mousedown' || e.type === 'touchstart') {
                e.preventDefault();
                 if (waitingForFirstTap) {
                    waitingForFirstTap = false;
                }

                if (gameState === 'simulation') {
                    if (isPaused) return;
                    bird.VELOCITY = -bird.LIFT;
                    impulseTimer = 20;
                    playJumpSound();
                } else if (gameState === 'game') {
                    if (isPaused) return;
                    bird.VELOCITY = -bird.LIFT;
                    playJumpSound();
                }
            }
        }
        
        // --- Event Listeners ---
        simModeButton.addEventListener('click', startSimulation); 
        gameModeButton.addEventListener('click', startGame);
        retryButton.addEventListener('click', startGame);
        exitToMenuButton.addEventListener('click', goToMenu);
        gameBackToMenuBtn.addEventListener('click', goToMenu);
        exitButton.addEventListener('click', goToMenu); 
        mobileExitBtn.addEventListener('click', goToMenu);
        pausePlayBtn.addEventListener('click', togglePause); mobilePausePlayBtn.addEventListener('click', togglePause);
        guideButton.addEventListener('click', openGuide); mobileGuideBtn.addEventListener('click', openGuide);
        closeGuideBtn.addEventListener('click', () => guidePopup.classList.add('hidden'));
        closeTabButton.addEventListener('click', () => window.close());

        liftSlider.addEventListener('input', handleLiftChange); mobileLiftSlider.addEventListener('input', handleLiftChange);
        massSlider.addEventListener('input', handleMassChange); mobileMassSlider.addEventListener('input', handleMassChange);

        Object.entries(planetButtons).forEach(([name, btn]) => btn.addEventListener('click', () => setGravity(name)));
        Object.entries(mobilePlanetButtons).forEach(([name, btn]) => btn.addEventListener('click', () => setGravity(name)));
        
        // Mobile Panel Logic
        function openMobilePanel() { mobilePanelOverlay.classList.remove('hidden'); setTimeout(() => { mobilePanel.classList.remove('-translate-x-full'); mobilePanelOverlay.classList.remove('opacity-0'); }, 10); }
        function closeMobilePanel() { mobilePanel.classList.add('-translate-x-full'); mobilePanelOverlay.classList.add('opacity-0'); setTimeout(() => mobilePanelOverlay.classList.add('hidden'), 300); }
        mobileMenuBtn.addEventListener('click', openMobilePanel);
        mobilePanelCloseBtnText.addEventListener('click', closeMobilePanel);
        mobilePanelOverlay.addEventListener('click', closeMobilePanel);
        
        window.onload=()=>{ 
            resizeCanvas(); 
            if (isMobile) {
                enterMobileExperience();
            }
            setup('simulation'); 
            startScreenLoop(); 
        };
        document.addEventListener('keydown',handleInput);canvas.addEventListener('mousedown',handleInput);canvas.addEventListener('touchstart',handleInput);window.addEventListener('resize', resizeCanvas);
        
        function updateSliderLabels(){
            const lift = parseFloat(liftSlider.value).toFixed(1);
            const mass = parseFloat(massSlider.value).toFixed(1);
            liftValue.textContent=lift; mobileLiftValue.textContent=lift;
            massValue.textContent=mass; mobileMassValue.textContent=mass;
        }

        function startScreenLoop(){if(gameState!=='start')return;ctx.clearRect(0,0,canvas.width,canvas.height);updateResponsiveSettings();manageEnvironment();bird.VELOCITY+=bird.GRAVITY;bird.y+=bird.VELOCITY;if(bird.y + bird.HEIGHT/2 > canvas.height){bird.y = canvas.height - bird.HEIGHT/2; bird.VELOCITY = 0;}drawBird();frameCount++;requestAnimationFrame(startScreenLoop)}

    </script>
</body>
</html>

